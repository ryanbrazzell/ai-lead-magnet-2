# Task Breakdown: PDF Generation Service

## Overview
Total Tasks: 32

**Goal:** Rebuild server-side PDF generation service that creates professional "EA Time Freedom Report" documents matching the existing production design, with S3 upload for permanent public URLs and base64 fallback on upload failure.

**Source Files to Port:**
- `/tmp/ea-time-freedom-report/app/utils/generatePDF.ts` (375 lines)
- `/tmp/ea-time-freedom-report/app/utils/s3Service.ts` (123 lines)
- `/tmp/ea-time-freedom-report/app/api/generate-pdf/route.ts` (185 lines)

**Target Location:** `/Users/ryanbrazzell/boundless-os-template-2/web/src/`

---

## Task List

### Types Layer

#### Task Group 1: PDF Generation Types
**Dependencies:** None (uses existing types from `/web/src/types/`)

- [x] 1.0 Complete PDF generation types
  - [x] 1.1 Write 3-4 focused tests for PDF type interfaces
    - Test PDFGenerationOptions interface structure
    - Test PDFGenerationResult interface structure
    - Test S3UploadOptions interface structure
    - Test PDFColorScheme interface structure
  - [x] 1.2 Create `/web/src/types/pdf.ts` with type definitions
    - Port PDFGenerationOptions interface from source
    - Port PDFGenerationResult interface from source
    - Define S3UploadOptions interface
    - Define PDFColorScheme interface with default colors
    - Reference source: `/tmp/ea-time-freedom-report/app/utils/generatePDF.ts` lines 5-22
  - [x] 1.3 Export types from `/web/src/types/index.ts`
    - Add re-exports for all PDF-related types
  - [x] 1.4 Ensure type tests pass
    - Run ONLY the 3-4 tests written in 1.1
    - Verify TypeScript compilation succeeds

**Acceptance Criteria:**
- The 3-4 tests written in 1.1 pass
- All PDF-related types are properly defined and exported
- Types integrate correctly with existing Task and UnifiedLeadData types
- TypeScript compilation succeeds without errors

---

### Utility Layer

#### Task Group 2: PDF Layout Utilities
**Dependencies:** Task Group 1

- [x] 2.0 Complete PDF layout utilities
  - [x] 2.1 Write 4-6 focused tests for layout utilities
    - Test addPDFHeader generates correct header structure
    - Test addExecutiveSummary renders summary with EA percentage
    - Test addKeyInsightsBox creates gray background box
    - Test addTaskSection formats tasks correctly with EA badges
    - Test addNextStepsSection renders CTA box
    - Test addFooterToAllPages adds footer to all pages
  - [x] 2.2 Create `/web/src/lib/pdf/layout.ts` with header section
    - Function: addPDFHeader(doc, leadData, colors)
    - Title: "EA Time Freedom Report" centered, 28pt bold, #111827
    - Lead info: name, title, businessType on separate lines, 14pt, #666666
    - Date: formatted as "Month Day, Year", 12pt
    - Separator line at y=55, color #e5e7eb
    - Reference source: lines 119-160 of generatePDF.ts
  - [x] 2.3 Add executive summary section
    - Function: addExecutiveSummary(doc, eaPercent, colors)
    - Section header: 18pt bold, #111827
    - Summary text with ea_task_percent highlighted
    - Wrap text to 165px width
    - Reference source: lines 162-177 of generatePDF.ts
  - [x] 2.4 Add key insights box
    - Function: addKeyInsightsBox(doc, tasks, eaPercent, yPosition, colors)
    - Gray background box (#f8f9fa) at 25, yPosition, 165x25
    - "Key Insights" header 14pt bold
    - Display total tasks and EA task count
    - Reference source: lines 179-197 of generatePDF.ts
  - [x] 2.5 Add task section rendering
    - Function: addTaskSection(doc, title, tasks, yPosition, colors)
    - Section header: 16pt bold, #111827
    - Task number and title on same line, 11pt bold
    - "EA Task" indicator right-aligned in green (#00cc6a) for isEA=true
    - Description wrapped to 155px, 10pt, #666666
    - Owner line: "Owner: EA" or "Owner: You", 9pt, #999999
    - Auto page-break when yPosition exceeds 260
    - Reference source: lines 199-265 of generatePDF.ts
  - [x] 2.6 Add next steps and CTA sections
    - Function: addNextStepsSection(doc, eaTaskCount, yPosition, colors)
    - Function: addCTABox(doc, yPosition, calendlyUrl, colors)
    - Green background box (#00cc6a) with white text
    - Configurable calendly URL with default
    - Reference source: lines 267-298 of generatePDF.ts
  - [x] 2.7 Add footer to all pages
    - Function: addFooterToAllPages(doc, colors)
    - Iterate through all pages using getNumberOfPages()
    - Separator line at y=280, #e5e7eb
    - Branding text centered at y=285: "Generated by Assistant Launch"
    - Page numbers centered at y=290: "Page X of Y"
    - Reference source: lines 306-324 of generatePDF.ts
  - [x] 2.8 Ensure layout utility tests pass
    - Run ONLY the 4-6 tests written in 2.1
    - Verify all layout functions work correctly

**Acceptance Criteria:**
- The 4-6 tests written in 2.1 pass
- All layout functions generate correct PDF structure
- Text wrapping and page breaks work correctly
- Footer appears on all pages
- Colors match production design exactly

---

### Service Layer

#### Task Group 3: PDF Generator Service
**Dependencies:** Task Groups 1, 2

- [x] 3.0 Complete PDF generator service
  - [x] 3.1 Write 4-6 focused tests for PDF generation
    - Test generatePDF creates valid PDF buffer
    - Test generatePDF with minimal lead data
    - Test generatePDF with full lead data
    - Test PDF contains correct number of pages (typically 4)
    - Test PDF includes all 30 tasks (10 per frequency)
    - Test error handling for invalid input
  - [x] 3.2 Create `/web/src/lib/pdf/generator.ts` main function
    - Function: generatePDF(report, leadData, options)
    - Initialize jsPDF document
    - Generate filename: `EA_Time_Freedom_Report_{FirstName}_{LastName}_{timestamp}.pdf`
    - Set up color scheme from options or defaults
    - Reference source: lines 27-107 of generatePDF.ts
  - [x] 3.3 Implement PDF content orchestration
    - Call layout utilities in correct order
    - Track yPosition throughout document
    - Handle page breaks automatically
    - Add footer to all pages after content complete
    - Reference source: lines 112-301 of generatePDF.ts (addPDFContent)
  - [x] 3.4 Implement output generation
    - Generate PDF as ArrayBuffer
    - Convert to Buffer for S3 upload
    - Generate base64 for API response
    - Return PDFGenerationResult with success, buffer, base64, filename, size
    - Reference source: lines 72-91 of generatePDF.ts
  - [x] 3.5 Add error handling and logging
    - Try/catch wrapper with timing metrics
    - Log start, success, and failure events
    - Return structured error in PDFGenerationResult on failure
    - Reference source: lines 93-106 of generatePDF.ts
  - [x] 3.6 Ensure PDF generator tests pass
    - Run ONLY the 4-6 tests written in 3.1
    - Verify PDF generation produces valid output

**Acceptance Criteria:**
- The 4-6 tests written in 3.1 pass
- PDF generation creates valid multi-page documents
- Output includes both buffer and base64 formats
- Error handling returns structured errors
- Logging captures timing and metrics

---

#### Task Group 4: S3 Upload Service
**Dependencies:** Task Group 1

- [x] 4.0 Complete S3 upload service
  - [x] 4.1 Write 4-6 focused tests for S3 service
    - Test uploadToS3 validates empty buffer
    - Test uploadToS3 validates 50MB size limit
    - Test uploadToS3 validates required env vars
    - Test generateSafeFilename sanitizes names correctly
    - Test generateSafeFilename limits length to 50 chars
    - Test S3 URL generation format is correct
  - [x] 4.2 Create `/web/src/lib/pdf/s3Service.ts` upload function
    - Function: uploadToS3(buffer, filename, options)
    - Validate buffer is non-empty and under 50MB
    - Validate required env vars: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, S3_BUCKET_NAME (or AWS_S3_BUCKET_NAME)
    - Initialize S3Client with credentials
    - Reference source: `/tmp/ea-time-freedom-report/app/utils/s3Service.ts` lines 22-57
  - [x] 4.3 Implement S3 upload logic
    - Ensure filename is in `reports/` folder
    - Use PutObjectCommand with:
      - ContentType: application/pdf
      - ContentDisposition: inline
      - CacheControl: 1 year (31536000 seconds)
    - Return permanent public URL format: `https://{bucket}.s3.{region}.amazonaws.com/reports/{filename}`
    - Reference source: lines 59-81 of s3Service.ts
  - [x] 4.4 Implement error handling
    - Catch NoSuchBucket error with specific message
    - Catch AccessDenied error with specific message
    - Log error details for debugging
    - Throw descriptive errors for caller to handle
    - Reference source: lines 82-100 of s3Service.ts
  - [x] 4.5 Create filename sanitization utility
    - Function: generateSafeFilename(firstName, lastName)
    - Sanitize to alphanumeric/underscore only
    - Limit each name to 50 chars
    - Pattern: `EA_Time_Freedom_Report_{FirstName}_{LastName}_{timestamp}.pdf`
    - Reference source: lines 110-122 of s3Service.ts
  - [x] 4.6 Ensure S3 service tests pass
    - Run ONLY the 4-6 tests written in 4.1
    - Verify all validation and sanitization works

**Acceptance Criteria:**
- The 4-6 tests written in 4.1 pass
- Buffer validation prevents empty and oversized uploads
- Environment variable validation catches missing credentials
- Filename sanitization prevents special characters
- Error messages are specific and actionable

---

### API Layer

#### Task Group 5: API Route Implementation
**Dependencies:** Task Groups 3, 4

- [x] 5.0 Complete API route
  - [x] 5.1 Write 4-6 focused tests for API endpoint
    - Test POST /api/generate-pdf returns success response
    - Test API returns 500 on generation failure
    - Test API returns PDF base64 when S3 fails (graceful fallback)
    - Test API returns both pdf and s3Url on full success
    - Test API validates required input fields
    - Test response includes generatedAt timestamp
  - [x] 5.2 Create `/web/src/app/api/generate-pdf/route.ts`
    - Export async function POST(request: NextRequest)
    - Parse request body: tasks, eaPercentage, userData (or equivalent structure)
    - Import generatePDF and uploadToS3 services
    - Reference source: `/tmp/ea-time-freedom-report/app/api/generate-pdf/route.ts` lines 1-10
  - [x] 5.3 Implement PDF generation call
    - Construct Report object from request data
    - Construct UnifiedLeadData from userData
    - Call generatePDF(report, leadData, options)
    - Handle generation errors with 500 response
    - Reference source: lines 5-146 of route.ts (PDF generation section)
  - [x] 5.4 Implement non-blocking S3 upload
    - Check for required S3 env vars before attempting upload
    - Convert base64 to Buffer for upload
    - Call generateSafeFilename for S3 key
    - Call uploadToS3 with PDF buffer
    - Log success or failure (non-critical)
    - Reference source: lines 150-169 of route.ts
  - [x] 5.5 Implement graceful degradation
    - If S3 upload fails, continue with null s3Url
    - Log S3 error but do not fail the request
    - Always return base64 PDF in response
    - Reference source: lines 165-168 of route.ts
  - [x] 5.6 Implement response structure
    - Return NextResponse.json with:
      - success: boolean
      - pdf: string (base64)
      - s3Url: string | null
      - generatedAt: ISO timestamp
    - On error: { success: false, error: string } with status 500
    - Reference source: lines 171-184 of route.ts
  - [x] 5.7 Ensure API route tests pass
    - Run ONLY the 4-6 tests written in 5.1
    - Verify all API behaviors work correctly

**Acceptance Criteria:**
- The 4-6 tests written in 5.1 pass
- API accepts TaskGenerationResult + UnifiedLeadData
- PDF generation works and returns base64
- S3 upload is attempted when credentials available
- Graceful fallback when S3 fails
- Response structure matches specification

---

### Testing Layer

#### Task Group 6: Test Review and Integration
**Dependencies:** Task Groups 1-5

- [x] 6.0 Review existing tests and fill critical gaps
  - [x] 6.1 Review tests from Task Groups 1-5
    - Review the 3-4 tests written by Task Group 1 (types) - Found 10 tests
    - Review the 4-6 tests written by Task Group 2 (layout) - Found 10 tests
    - Review the 4-6 tests written by Task Group 3 (generator) - Found 6 tests
    - Review the 4-6 tests written by Task Group 4 (S3 service) - Found 12 tests
    - Review the 4-6 tests written by Task Group 5 (API route) - Found 6 tests
    - Total existing tests: 44 tests (exceeded expectations)
  - [x] 6.2 Analyze test coverage gaps for PDF service only
    - Identify critical end-to-end workflows that lack coverage
    - Focus ONLY on gaps related to PDF generation spec requirements
    - Do NOT assess entire application test coverage
    - Prioritize integration points over unit test gaps
  - [x] 6.3 Write up to 6 additional strategic tests maximum
    - Add end-to-end test: full PDF generation flow
    - Add integration test: API to S3 upload path
    - Add visual validation: compare generated PDF structure
    - Add edge case: very long task descriptions
    - Add edge case: special characters in lead names
    - Add performance test: PDF generation under 5 seconds
  - [x] 6.4 Run feature-specific tests only
    - Run ONLY tests related to PDF generation spec
    - Final total: 50 tests (6 test files)
    - Do NOT run the entire application test suite
    - Verify all critical workflows pass - ALL PASSED

**Acceptance Criteria:**
- All feature-specific tests pass (50 tests total) - ACHIEVED
- Critical user workflows for PDF generation are covered - ACHIEVED
- No more than 6 additional tests added when filling gaps - ACHIEVED (6 tests added)
- Testing focused exclusively on this spec's requirements - ACHIEVED
- Generated PDF matches production design visually - VERIFIED via structural tests

---

## Execution Order

Recommended implementation sequence:

1. **Types Layer** (Task Group 1) - Define all interfaces first
2. **Utility Layer** (Task Group 2) - Build reusable layout functions
3. **PDF Generator Service** (Task Group 3) - Core PDF generation logic
4. **S3 Upload Service** (Task Group 4) - Can be done in parallel with Group 3
5. **API Route** (Task Group 5) - Wire everything together
6. **Test Review & Integration** (Task Group 6) - Validate complete system

---

## File Structure (Target)

```
/web/src/
  /types/
    pdf.ts                  # PDFGenerationOptions, PDFGenerationResult, etc.
    index.ts                # Re-export PDF types
  /lib/
    /pdf/
      layout.ts             # PDF layout utilities (header, sections, footer)
      generator.ts          # Main generatePDF function
      s3Service.ts          # S3 upload and filename utilities
      index.ts              # Re-export all PDF utilities
      __tests__/
        layout.test.ts      # 10 layout tests
        generator.test.ts   # 6 generator tests
        s3Service.test.ts   # 12 S3 service tests
        integration.test.ts # 6 integration tests (NEW)
  /app/
    /api/
      /generate-pdf/
        route.ts            # POST /api/generate-pdf endpoint
        __tests__/
          route.test.ts     # 6 API route tests
```

---

## Key Dependencies

**npm packages required:**
- `jspdf` (v2.5.2 - already in project, locked)
- `@aws-sdk/client-s3` (v3.x for S3 operations)

**Existing types used:**
- `TaskGenerationResult` from `/web/src/types/task.ts`
- `UnifiedLeadData` from `/web/src/types/lead.ts`

**Environment variables required:**
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_REGION` (default: us-east-1)
- `S3_BUCKET_NAME` or `AWS_S3_BUCKET_NAME`

---

## Visual Reference

**Sample PDF for comparison:** `/tmp/ea-time-freedom-report/.playwright-mcp/EA-Time-Freedom-Report-Ryan-Brazzell.pdf`

**Design Constants:**
- Primary color: #141414 (dark text)
- Secondary color: #00cc6a (EA badge, CTA box)
- Text color: #333333 (body text)
- Light gray: #f8f9fa (key insights box)
- Border gray: #e5e7eb (separator lines)
- Gray text: #666666, #999999 (subtitles, owner text)
