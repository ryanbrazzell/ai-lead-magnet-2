# Specification: PDF Generation Service

## Goal

Rebuild server-side PDF generation service that creates professional "EA Time Freedom Report" documents matching the existing production design, with S3 upload for permanent public URLs and base64 fallback on upload failure.

## User Stories

- As a lead, I want to receive a professionally formatted PDF report so that I can review my task delegation analysis offline
- As the system, I want to store PDFs in S3 with permanent URLs so that email links remain accessible long-term

## Specific Requirements

**PDF Document Structure**
- Generate multi-page PDF (typically 4 pages) using jsPDF library server-side
- Page 1: Header with title, lead info (name, title, company), and date
- Page 1: Executive Summary section with EA percentage highlight
- Page 1: Key Insights box with gray background showing total tasks and EA task count
- Pages 2-4: Task sections for Daily, Weekly, and Monthly (10 tasks each)
- Final section: Next Steps summary and green CTA box with calendly link
- Footer on all pages: "Generated by Assistant Launch" branding and page numbers

**Header Section Layout**
- Title: "EA Time Freedom Report" centered, 28pt bold, color #111827
- Subtitle: Lead full name, title, and businessType on separate lines, 14pt, color #666666
- Date: Current date formatted as "Month Day, Year", 12pt
- Separator line at y=55 using color #e5e7eb

**Task Section Rendering**
- Section headers: 16pt bold, color #111827
- Task number and title on same line (e.g., "1. Task Title"), 11pt bold
- "EA Task" indicator right-aligned in green (#00cc6a) for isEA=true tasks
- Description wrapped to 155px width, 10pt normal, color #666666
- Owner line below description: "Owner: EA" or "Owner: You", 9pt, color #999999
- Auto page-break when yPosition exceeds 260

**Footer Implementation**
- Add footer to ALL pages after content is complete using getNumberOfPages()
- Separator line at y=280, color #e5e7eb
- Branding text centered at y=285: "Generated by Assistant Launch" with assistantlaunch.com
- Page numbers centered at y=290: "Page X of Y" format

**CTA Box**
- Green background box (#00cc6a) with white text
- Text: "Ready to get started? Schedule your consultation:"
- Calendly URL: configurable via prop, default to "calendly.com/assistantlaunch/discovery-call"

**S3 Upload Service**
- Upload PDF buffer to AWS S3 bucket in `reports/` folder
- Filename pattern: `EA_Time_Freedom_Report_{FirstName}_{LastName}_{timestamp}.pdf`
- Sanitize names to alphanumeric/underscore only, limit 50 chars each
- Return permanent public URL: `https://{bucket}.s3.{region}.amazonaws.com/reports/{filename}`
- Set Content-Type: application/pdf, Cache-Control: 1 year

**S3 Error Handling**
- Validate buffer is non-empty and under 50MB limit
- Check for required env vars: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, S3_BUCKET_NAME or AWS_S3_BUCKET_NAME
- Provide specific error messages for NoSuchBucket, AccessDenied
- On S3 failure: log error and return base64 PDF as graceful fallback

**API Endpoint Structure**
- Route: POST `/api/generate-pdf`
- Accept: TaskGenerationResult (tasks, ea_task_percent) + UnifiedLeadData (firstName, lastName, title, businessType)
- Return: { success: boolean, pdf: string (base64), s3Url: string | null, generatedAt: string }
- Return 500 with { success: false, error: string } on generation failure

**Input/Output Types**
- Input uses existing types from `/web/src/types/`: TaskGenerationResult, UnifiedLeadData
- Define PDFGenerationOptions interface: customColors, includeMetadata, watermark
- Define PDFGenerationResult interface: success, buffer, base64, filename, size, error

## Existing Code to Leverage

**`/tmp/ea-time-freedom-report/app/utils/generatePDF.ts`**
- Port exact layout logic including yPosition tracking and page break calculations
- Reuse color scheme: primary #141414, secondary #00cc6a, text #333333, lightGray #f8f9fa, borderGray #e5e7eb
- Replicate addPDFContent, addFooterToAllPages functions
- Use identical font sizes and positioning values

**`/tmp/ea-time-freedom-report/app/utils/s3Service.ts`**
- Port uploadToS3 function with S3Client and PutObjectCommand
- Replicate generateSafeFilename sanitization logic
- Use same env var fallback pattern: S3_BUCKET_NAME || AWS_S3_BUCKET_NAME

**`/tmp/ea-time-freedom-report/app/api/generate-pdf/route.ts`**
- Follow same API response structure with success, pdf, s3Url fields
- Replicate non-blocking S3 upload pattern with graceful failure handling

**`/web/src/types/task.ts` and `/web/src/types/lead.ts`**
- Use existing Task, TasksByFrequency, TaskGenerationResult interfaces
- Use existing UnifiedLeadData interface for lead information

**`/web/src/lib/ai/` architecture pattern**
- Follow established pattern of separate module files in `/lib` folder
- Use similar error handling and logging patterns from existing AI services

## Out of Scope

- PDF design changes or visual modernization beyond matching existing production
- Custom font embedding (use Helvetica only as in original)
- Presigned S3 URLs with expiration (use permanent public URLs)
- PDF encryption or password protection
- Batch PDF generation for multiple reports
- PDF preview rendering in browser before generation
- Email delivery integration (separate spec)
- Client-side PDF generation (server-side only)
- PDF metadata beyond basic document properties
- Watermark functionality (code exists but not actively used)
