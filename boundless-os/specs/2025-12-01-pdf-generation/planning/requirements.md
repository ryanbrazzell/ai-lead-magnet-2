# Spec Requirements: PDF Generation Service

## Initial Description

PDF Generation Service - Rebuild server-side jsPDF generation matching existing report design; verify AWS S3 upload and URL generation works correctly.

**Roadmap Reference:** Item #5 - Phase 1: Core Infrastructure

## Requirements Discussion

### Research Findings

**Primary Source Code:** `/tmp/ea-time-freedom-report/`

**Key Files Identified:**
- `app/utils/generatePDF.ts` (375 lines) - Core PDF generation utility
- `app/utils/s3Service.ts` (123 lines) - AWS S3 upload service
- `app/api/generate-pdf/route.ts` (185 lines) - API endpoint

**Sample PDF:** `/tmp/ea-time-freedom-report/.playwright-mcp/EA-Time-Freedom-Report-Ryan-Brazzell.pdf`

### PDF Design Specifications

**Document Structure (4 pages typical):**
1. **Header Section:**
   - Title: "Your EA Time Freedom Report" (28pt, bold, #111827)
   - Subtitle: Lead name, title, company (14pt, gray)
   - Date: Current date in "Month Day, Year" format

2. **Executive Summary:**
   - Generated summary from AI output
   - EA percentage highlight

3. **Task Sections:**
   - Daily Tasks & Responsibilities (10 tasks)
   - Weekly Tasks & Responsibilities (10 tasks)
   - Monthly Tasks & Responsibilities (10 tasks)

4. **Task Format:**
   - Numbered list (1., 2., 3., etc.)
   - Task title (bold)
   - "EA Task" badge (green #00cc6a) for EA-delegatable tasks
   - Description paragraph
   - Owner indicator ("EA" or "You")

5. **Footer:**
   - "Generated by Assistant Launch - assistantlaunch.com"
   - Page numbers (Page X of Y)

6. **CTA Box:**
   - Call-to-action at end of document
   - Link to scheduling/calendar

**Typography:**
- Font: Helvetica (standard jsPDF font, no custom fonts)
- Title: 28pt bold
- Section headers: 18pt bold
- Body text: 11pt regular
- Colors: Dark gray (#111827), Gray (#6b7280), Green EA badge (#00cc6a)

### S3 Configuration

**Storage Structure:**
- Bucket folder: `reports/`
- Filename pattern: `EA_Time_Freedom_Report_{FirstName}_{LastName}_{timestamp}.pdf`
- Example: `EA_Time_Freedom_Report_Ryan_Brazzell_1701456789123.pdf`

**URL Format:**
- Pattern: `https://{bucket}.s3.{region}.amazonaws.com/reports/{filename}`
- Access: Permanent public URLs (no expiration)
- Content-Type: `application/pdf`
- Cache-Control: 1 year

**Limits:**
- Max file size: 50MB
- Typical report size: ~100KB for 30 tasks

### Environment Variables Required

```
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_REGION=us-east-1 (or your region)
AWS_S3_BUCKET=your-bucket-name
```

### Clarifying Questions & Answers

**Q1:** Preserve exact visual design?
**Answer:** Yes - keep identical layout, fonts, colors, "EA Task" badges.

**Q2:** Keep jsPDF library?
**Answer:** Yes - it's LOCKED in tech stack and works well.

**Q3:** Keep permanent public URLs?
**Answer:** Yes - required for long-term email access.

**Q4:** Consolidate to single service?
**Answer:** Yes - create clean, well-tested service architecture.

**Q5:** Graceful degradation on S3 failure?
**Answer:** Yes - return base64 PDF if S3 upload fails.

**Q6:** CTA box URL?
**Answer:** Keep existing calendly reference, make configurable via prop.

**Q7:** PDF metadata?
**Answer:** Keep minimal approach (current behavior).

**Q8:** Edge cases?
**Answer:** Preserve existing handling, no known production issues.

### Existing Code to Leverage

| Resource | Path | Usage |
|----------|------|-------|
| PDF Generator | `/tmp/ea-time-freedom-report/app/utils/generatePDF.ts` | Port exact PDF layout logic |
| S3 Service | `/tmp/ea-time-freedom-report/app/utils/s3Service.ts` | Port S3 upload logic |
| API Route | `/tmp/ea-time-freedom-report/app/api/generate-pdf/route.ts` | Reference API structure |
| Sample PDF | `/tmp/ea-time-freedom-report/.playwright-mcp/EA-Time-Freedom-Report-Ryan-Brazzell.pdf` | Visual reference |
| Task Types | `/web/src/types/task.ts` | TaskGenerationResult interface |
| Lead Types | `/web/src/types/lead.ts` | UnifiedLeadData interface |

### Visual Assets

**Sample PDF analyzed:** Shows professional 4-page report with clean layout, numbered tasks, green EA badges, and footer branding.

## Requirements Summary

### Functional Requirements

**PDF Generation:**
- Generate 4-page PDF report from TaskGenerationResult + lead data
- Match exact visual design of existing production PDF
- Use jsPDF library (server-side, Helvetica font)
- Support 30 tasks (10 daily, 10 weekly, 10 monthly)
- Include EA task highlighting with green badge
- Include executive summary with EA percentage
- Include CTA box at document end

**S3 Upload:**
- Upload generated PDF to AWS S3
- Store in `reports/` folder with standardized filename
- Return permanent public URL
- Handle upload failures gracefully (return base64 fallback)

**API Endpoint:**
- POST `/api/generate-pdf`
- Accept TaskGenerationResult + UnifiedLeadData
- Return PDF URL and optional base64 data

### Technical Considerations

**Dependencies:**
- jsPDF v2.5.2 (existing, locked)
- AWS SDK v3 for S3 operations
- Types from `/web/src/types/` (TaskGenerationResult, UnifiedLeadData)

**Server-Side Only:**
- PDF generation runs on server (API route)
- No client-side PDF generation

**Error Handling:**
- S3 upload failure → return base64 PDF (graceful degradation)
- Generation failure → return structured error
- Invalid input → return 400 with validation errors

### Scope Boundaries

**In Scope:**
- Port generatePDF.ts utility to new architecture
- Port s3Service.ts utility to new architecture
- Create `/api/generate-pdf` API route
- Preserve exact PDF visual design
- S3 upload with permanent public URLs
- Base64 fallback on S3 failure
- Unit tests for PDF generation
- Integration tests for S3 upload

**Out of Scope:**
- PDF design changes or modernization
- Custom fonts (stick with Helvetica)
- Presigned URLs with expiration
- PDF encryption or password protection
- Batch PDF generation
- PDF preview in browser
- Email delivery (separate spec)

### Dependencies

**Required Before:**
- AI Task Generation Service (Item #4) ✅ Complete
- Environment Setup (Item #1) - for AWS credentials

**Required By:**
- Main Form Submission (Item #9)
- Standard Form Build (Item #10)
- Preselected Form Completion (Item #12)
- Email Service (Item #6)
